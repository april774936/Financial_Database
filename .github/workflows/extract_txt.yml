name: Extract Historical TXT

on:
  workflow_dispatch: # 사용자가 버튼을 누를 때만 실행

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pandas fredapi

      - name: Run Extraction Script
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          # 파이썬 코드를 즉석에서 실행하여 파일 생성
          python -c "
          import os, time, pandas as pd
          from fredapi import Fred
          fred = Fred(api_key=os.environ.get('FRED_API_KEY'))
          fred_dict = {
              'NASDAQ100': ['ASSETS', '나스닥100', 1], 'SP500': ['ASSETS', 'S&P500', 1], 'DJIA': ['ASSETS', '다우존스', 1],
              'DCOILWTICO': ['ASSETS', 'WTI원유', 1], 'CBBTCUSD': ['ASSETS', '비트코인', 1], 'CBETHUSD': ['ASSETS', '이더리움', 1],
              'GOLDAMGBD228NLBM': ['ASSETS', '금_현물', 1], 'ID71081': ['ASSETS', '은_현물', 1], 'PCOPPUSDM': ['ASSETS', '구리_현물', 1],
              'WALCL': ['LIQUID', '연준총자산', 1000000], 'M2SL': ['LIQUID', 'M2통화량', 1000], 'WTREGEN': ['LIQUID', 'TGA잔고', 1],
              'RRPONTSYD': ['LIQUID', '역레포잔고', 1], 'DFEDTARU': ['LIQUID', '기준금리(상단)', 1], 'T10Y2Y': ['LIQUID', '장단기금리차', 1],
              'DGS10': ['LIQUID', '미_10년물_금리', 1], 'DGS2': ['LIQUID', '미_2년물_금리', 1], 'BAMLH0A0HYM2': ['LIQUID', '정크본드스프레드', 1],
              'VIXCLS': ['LIQUID', 'VIX공포지수', 1], 'CPIAUCSL': ['MACRO', 'CPI', 1], 'PPIACO': ['MACRO', 'PPI', 1],
              'UNRATE': ['MACRO', '실업률', 1], 'GDPC1': ['MACRO', '실질GDP', 1], 'CSUSHPINSA': ['MACRO', '미국주택가격지수', 1],
              'UMCSENT': ['MACRO', '소비자심리지수', 1], 'DEXKOUS': ['MACRO', '원달러환율', 1], 'DTWEXBGS': ['MACRO', '달러인덱스', 1],
              'PCE': ['MACRO', '개인소비지출', 1], 'RSXFS': ['MACRO', '소매판매', 1], 'DGORDER': ['MACRO', '내구재주문', 1],
              'TDSP': ['MACRO', '가계부채상환비율', 1], 'TOTLL': ['MACRO', '은행총대출', 1]
          }
          content_map = {'ASSETS': '', 'LIQUID': '', 'MACRO': ''}
          for ticker, info in fred_dict.items():
              try:
                  s = fred.get_series(ticker, observation_start='1970-01-01', observation_end='2024-12-31')
                  for date, val in s.items():
                      if pd.notna(val):
                          content_map[info[0]] += f'{date.strftime(\"%Y-%m-%d\")}, {info[1]}, {round(float(val)/info[2], 3)}\n'
                  time.sleep(0.2)
              except: continue
          for group, content in content_map.items():
              with open(f'HISTORICAL_{group}.txt', 'w', encoding='utf-8') as f:
                  f.write(content)
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: historical-data-txt
          path: HISTORICAL_*.txt
